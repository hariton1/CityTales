<button
  tuiButton
  type="button"
  appearance="flat"
  size="s"
  class="back-button"
  (click)="closeDetail()"
>
  <tui-icon icon="@tui.chevron-left" class="mr-1" [style.height.rem]="1.2" />
  Back to All Sites
</button>

<div class="scroll-wrapper">
  <div class="place-detail-container">
    <section
      tuiCardLarge="compact"
      [tuiCardCollapsed]="collapsed()"
      class="tui-space_bottom-5"
    >

      <div class="image-info-flex">
        <div class="image-container" *ngIf="selectedPerson.imageUrls.length > 0">
          <img [src]="
            selectedPerson.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
            ? 'assets/images/building-placeholder-500.jpeg'
            : selectedPerson.imageUrls[1]"
               alt="{{ selectedPerson.name }}" />
        </div>

        <div class="info-block">
          <header tuiHeader class="tui-space_bottom-5">
            <hgroup>
              <h1 class="place-title tui-space_bottom-2" tuiTitle>{{selectedPerson.name}}</h1>
              <p tuiSubtitle>
               <span class="icon-and-text">
                <span class="icon">
                  <tui-icon icon="@tui.activity" [style.height.rem]="1.3" />
                </span>
                 <span *ngIf="selectedPerson.birthDate != null">
                  {{ selectedPerson.birthDate }}
                </span>
                <span *ngIf="selectedPerson.deathDate != null">
                  †{{ selectedPerson.deathDate }}
                </span>
              </span>
              </p>
            </hgroup>
          </header>

          <div *ngIf="funFact" class="fun-fact-card tui-space_bottom-3">
            <tui-icon icon="@tui.star" [style.height.rem]="1.2" class="mr-2"></tui-icon>
            <strong>Fun Fact:</strong> {{ funFact.fact }}
            <span *ngIf="funFact.score">&nbsp;(Score: {{ funFact.score }})</span>
            <button
              tuiButton
              appearance="outline"
              size="s"
              class="merken-btn tui-space_left-3"
              (click)="saveFunFact()"
              [disabled]="funFactSaved"
            >
              <ng-container *ngIf="funFactSaved; else notSaved">
                <tui-icon icon="@tui.heart" [style.height.rem]="1.1" class="heart full"></tui-icon>
                Gespeichert!
              </ng-container>
              <ng-template #notSaved>
                <tui-icon icon="@tui.heart" [style.height.rem]="1.1" class="heart empty"></tui-icon>
                Merken
              </ng-template>
            </button>
          </div>
          <div *ngIf="funFactSaveError" class="error-message">
            {{ funFactSaveError }}
          </div>
          <div *ngIf="funFactSaved" class="success-message">
            Fun Fact wurde gespeichert!
          </div>

          <div class="detail-row icon-and-text tui-space_bottom-3" *ngIf="selectedPerson.jobs">
          <span class="icon-and-text">
            <span class="icon">
              <tui-icon icon="@tui.briefcase-business" [style.height.rem]="1.2" />
            </span>

            <strong> Jobs: </strong> {{ selectedPerson.jobs }}
          </span>
          </div>

          <div class="detail-row icon-and-text tui-space_bottom-3" *ngIf="selectedPerson.sex">
          <span class="icon-and-text">
            <span class="icon">
              <tui-icon icon="@tui.venus-and-mars" [style.height.rem]="1.2" />
            </span>

            <strong> Sex: </strong> {{ selectedPerson.sex }}
          </span>
          </div>

          <div class="detail-row icon-and-text tui-space_bottom-3" *ngIf="selectedPerson.birthPlace">
          <span class="icon-and-text">
            <span class="icon">
              <tui-icon icon="@tui.map-pin-house" [style.height.rem]="1.2" />
            </span>

            <strong> Birth Place: </strong> {{ selectedPerson.birthPlace }}
          </span>
          </div>

          <div class="detail-row icon-and-text tui-space_bottom-3" *ngIf="selectedPerson.deathPlace">
          <span class="icon-and-text">
            <span class="icon">
              <tui-icon icon="@tui.skull" [style.height.rem]="1.2" />
            </span>

            <strong> Death Place: </strong> {{ selectedPerson.deathPlace }}
          </span>
        </div>

          <div>
            <button class="tui-space_top-4" appearance="outline" size="s" tuiButton type="button"
                    (click)="navigateToFeedback()">
              <tui-icon icon="@tui.message-circle-plus" [style.height.rem]="1"/>
              Is something incorrect?
            </button>
          </div>



          <div class="bottom-right-button">

            <button
              appearance="secondary"
              size="s"
              tuiButton
              type="button"
              [tuiChevron]="!collapsed()"
              (click)="collapsed.set(!collapsed())"
            >
              Sources
            </button>
          </div>
        </div>
      </div>

      <tui-expand [expanded]="!collapsed()">
        <div class="detail-row" *ngIf="selectedPerson.url">
          <span class="label">Wiki URL: </span>
          <span class="value">
              <a [href]="selectedPerson.url" target="_blank"> {{ selectedPerson.url }} </a>
            </span>
        </div>
      </tui-expand>
    </section>


  <div class="tone-selector" *ngIf="selectedPerson.contentGerman">
    <span style="font: var(--tui-font-heading-6); display: block; width: 100%">Choose how you want the story to be told <tui-icon
      tuiHintDirection="bottom"
      tuiTooltip="Select a tone to change the storytelling style — not the facts."
    /></span>

    <tui-carousel
      [draggable]="true"
      [itemsCount]="tonesItemCount"
      [(index)]="index1"
    >
      <ng-container *ngFor="let tone of tones">
        <button
          *tuiItem
          tuiSurface
          type="button"
          class="tone"
          [style.background-image]="'url(assets/images/' + tone.bg + ')'"
          [style.color]="'#fff'"
          (click)="startEnrichment(tone.key)"
        >
          <h3 class="heading">{{ tone.label }}</h3>
        </button>
      </ng-container>
    </tui-carousel>
  </div>

  <div class="tone-selector" *ngIf="!selectedPerson.contentGerman">
    <span style="font: var(--tui-font-heading-6); display: block; width: 100%">We haven’t written a story for this person yet — stay tuned!</span>
  </div>

  <!-- tone selector -->
  <div class="content">
    <!-- Skeleton Loader -->
    <div *ngIf="enrichmentStarted && enrichmentLoading" class="fade-in place-summary tui-space_bottom-8">
      <div class="skeleton-line" *ngFor="let width of lineWidths" [style.width.%]="width"></div>
    </div>

    <!-- LLM Generated Content -->
    <div *ngIf="enrichmentStarted && !enrichmentLoading" class="fade-in tui-space_bottom-12">
      <section class="place-summary">
        <header tuiHeader class="tui-space_top-3 tui-space_bottom-3">
          <span class="tui-text_h6">Quick Facts & Highlights</span>
        </header>
        <div class="place-summary-text" [innerHTML]="summary"></div>

        <header tuiHeader class="tui-space_top-5 tui-space_bottom-3">
          <span class="tui-text_h6">Deep Dive into the {{ selectedPerson.name }}</span>
        </header>
        <div class="place-summary-text" [innerHTML]="enrichedContent"></div>
      </section>
    </div>


    <div class="related-persons tui-space_bottom-6" *ngIf="selectedPerson.relatedPersons?.length">
      <span class="tui-space_bottom-5" style="font: var(--tui-font-heading-6); display: block; width: 100%"><tui-icon icon="@tui.user" [style.height.rem]="1.5" /> Related Persons</span>

      <tui-carousel
        [draggable]="true"
        [itemsCount]="3"
        [(index)]="index2"
        [style.--tui-carousel-padding] = "isMobile ? '0' : '0 15px 0 0'"
      >
        <ng-container *ngFor="let person of selectedPerson.relatedPersons">
          <div
            tuiAppearance="outline-grayscale"
            tuiCardLarge
            *tuiItem
            class="person-card"
          >
            <div (click)="onPersonClick(person)">
              <aside tuiAccessories>
                <tui-avatar
                  class="avatar"
                  size="l"
                  [src]="
              person.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'assets/images/person-placeholder-200.png'
                : (person.imageUrls[1] | tuiFallbackSrc: '@tui.user' | async)
            "
                  [style.background]="
              person.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'transparent'
                : (person.imageUrls[1] | tuiAutoColor)
            "
                />
              </aside>
              <h2 tuiTitle>
                {{ person.name }}
                <span tuiSubtitle *ngIf="person.deathDate != null">
            †{{ person.deathDate }}
          </span>
              </h2>
            </div>
          </div>
        </ng-container>
      </tui-carousel>
      <tui-pagination
        *ngIf="selectedPerson.relatedPersons?.length > 3"
        size="s"
        class="tui-space_top-4"
        [index]="roundedPersons"
        [length]="personsPageCount"
        (indexChange)="onIndexPersons($event)"
      />
    </div>

    <div class="related-buildings tui-space_bottom-6" *ngIf="selectedPerson.relatedBuildings?.length">
      <span class="tui-space_bottom-5" style="font: var(--tui-font-heading-6); display: block; width: 100%"><tui-icon icon="@tui.landmark" [style.height.rem]="1.5" /> Related Buildings</span>

      <tui-carousel
        [draggable]="true"
        [itemsCount]="3"
        [(index)]="index3"
        [style.--tui-carousel-padding] = "isMobile ? '0' : '0 15px 0 0'"
      >
        <ng-container *ngFor="let building of selectedPerson.relatedBuildings">
          <div
            tuiAppearance="outline-grayscale"
            tuiCardLarge
            *tuiItem
            class="person-card"
          >
            <div (click)="onBuildingClick(building)">
              <aside tuiAccessories>
                <tui-avatar
                  class="avatar"
                  size="l"
                  [src]="
              building.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'assets/images/building-placeholder-200.jpeg'
                : (building.imageUrls[1] | tuiFallbackSrc: '@tui.user' | async)
            "
                  [style.background]="
              building.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'transparent'
                : (building.imageUrls[1] | tuiAutoColor)
            "
                />
              </aside>
              <h2 tuiTitle>
                {{ building.name }}

              </h2>
            </div>
          </div>
        </ng-container>
      </tui-carousel>
      <tui-pagination
        *ngIf="selectedPerson.relatedBuildings?.length > 3"
        size="s"
        class="tui-space_top-4"
        [index]="roundedBuildings"
        [length]="buildingsPageCount"
        (indexChange)="onIndexBuildings($event)"
      />
    </div>


    <div class="related-events tui-space_bottom-6" *ngIf="selectedPerson.relatedEvents?.length">
      <span class="tui-space_bottom-5" style="font: var(--tui-font-heading-6); display: block; width: 100%"><tui-icon icon="@tui.calendar" [style.height.rem]="1.5" /> Related Events</span>

      <tui-carousel
        [draggable]="true"
        [itemsCount]="3"
        [(index)]="index4"
        [style.--tui-carousel-padding] = "isMobile ? '0' : '0 15px 0 0'"
      >
        <ng-container *ngFor="let event of selectedPerson.relatedEvents">
          <div
            tuiAppearance="outline-grayscale"
            tuiCardLarge
            *tuiItem
            class="person-card"
          >
            <div (click)="onEventClick(event)">
              <aside tuiAccessories>
                <tui-avatar
                  class="avatar"
                  size="l"
                  [src]="
              event.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'assets/images/event-placeholder-200.jpeg'
                : (event.imageUrls[1] | tuiFallbackSrc: '@tui.user' | async)
            "
                  [style.background]="
              event.imageUrls[1] === 'https://www.geschichtewiki.wien.gv.at/images/7/7d/RDF.png'
                ? 'transparent'
                : (event.imageUrls[1] | tuiAutoColor)
            "
                />
              </aside>
              <h2 tuiTitle>
                {{ event.name }}
              </h2>
            </div>
          </div>
        </ng-container>
      </tui-carousel>
      <tui-pagination
        *ngIf="selectedPerson.relatedEvents?.length > 3"
        size="s"
        class="tui-space_top-4"
        [index]="roundedEvents"
        [length]="eventsPageCount"
        (indexChange)="onIndexEvents($event)"
      />
    </div>

  </div>
  </div>

</div>
